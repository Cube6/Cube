version: '3.4'

# Steps:

# Go the root directory of Cube
# 1. 
# Generate Certificate from .NET CLI or CMD
# dotnet dev-certs https -ep %USERPROFILE%\.aspnet\https\aspnetapp.pfx -p Welcome1
# dotnet dev-certs https --trust

# 2. 
# docker-compose build
# docker-compose up

services:

  # Board Microservice #
  boardapi1: #定义"boardapi1"服务 对应的Board服务项目
     image: boardapi #指定镜像名称
     build: 
       context: .
       dockerfile: ./src/Services/Board/Board.API/Dockerfile
     ports: 
        - '5000:5000'
     environment: 
            - ASPNETCORE_URLS=https://+:5000
            - Consul:Ip=boardapi1
            - Consul:Port=5000            
            - Consul:IsHttps=true
            - ASPNETCORE_Kestrel__Certificates__Default__Password=Welcome1
            - ASPNETCORE_Kestrel__Certificates__Default__Path=/https/aspnetapp.pfx
     volumes:
            - ~/.aspnet/https:/https:ro
     networks: 
            - my-net
     depends_on: 
            - consul

  boardapi2:
     image: boardapi
     ports: 
        - '5001:5001'
     environment: 
            - ASPNETCORE_URLS=https://+:5001
            - Consul:Ip=boardapi2
            - Consul:Port=5001            
            - Consul:IsHttps=true
            - ASPNETCORE_Kestrel__Certificates__Default__Password=Welcome1
            - ASPNETCORE_Kestrel__Certificates__Default__Path=/https/aspnetapp.pfx
     volumes:
            - ~/.aspnet/https:/https:ro
     networks: 
            - my-net
     depends_on: 
            - boardapi1

  boardapi3:
     image: boardapi
     ports: 
        - '5002:5002'
     environment: 
            - ASPNETCORE_URLS=https://+:5002
            - Consul:Ip=boardapi3
            - Consul:Port=5002            
            - Consul:IsHttps=true
            - ASPNETCORE_Kestrel__Certificates__Default__Password=Welcome1
            - ASPNETCORE_Kestrel__Certificates__Default__Path=/https/aspnetapp.pfx
     volumes:
            - ~/.aspnet/https:/https:ro
     networks: 
            - my-net
     depends_on: 
            - boardapi1

  # User Microservice #
  userapi1:
     image: userapi
     build: 
       context: .
       dockerfile: ./src/Services/User/User.API/Dockerfile
     ports: 
        - '4000:4000'
     environment: 
            - ASPNETCORE_URLS=https://+:4000
            - Consul:Ip=userapi1
            - Consul:Port=4000
            - Consul:IsHttps=true
            - ASPNETCORE_Kestrel__Certificates__Default__Password=Welcome1
            - ASPNETCORE_Kestrel__Certificates__Default__Path=/https/aspnetapp.pfx
     volumes:
            - ~/.aspnet/https:/https:ro
     networks: 
            - my-net
     depends_on: 
            - consul

  # Identity Microservice #
  identityapi1:
     image: identityapi
     build: 
       context: .
       dockerfile: ./src/Services/Identity/Identity.API/Dockerfile
     ports: 
        - '3000:3000'
     environment: 
            - ASPNETCORE_URLS=https://+:3000
            - Consul:Ip=identityapi1
            - Consul:Port=3000            
            - Consul:IsHttps=true
            - UserService:Scheme=https
            - UserService:Host=userapi1
            - UserService:Port=4000
            - ASPNETCORE_Kestrel__Certificates__Default__Password=Welcome1
            - ASPNETCORE_Kestrel__Certificates__Default__Path=/https/aspnetapp.pfx
     volumes:
            - ~/.aspnet/https:/https:ro
     networks:
            - my-net
     depends_on: 
            - consul
            - userapi1

  # Gateway Service #
  gateway:
    build:
      context: .
      dockerfile: ./src/ApiGateway/Dockerfile
    ports:
         - '9070:9070' 
    environment: 
         - ASPNETCORE_URLS=http://+:9070
    networks:
         - my-net
    depends_on: 
         - boardapi1
         - boardapi2
         - boardapi3
         - userapi1
         - identityapi1

  # Consul Service #
  consul:
     image: consul #指定镜像名称为consul，本地如果没有consul镜像，会从docker远程仓库拉取
     ports: 
           - '8500:8500'
     networks: 
           - my-net
networks: #定义容器网络
  my-net: #my-net网络
    driver: bridge #网络模式为bridge