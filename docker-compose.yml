version: '3.4'

services:
  #board.api:
  #  image: boardapi
  #  build:
  #    context: .
  #    dockerfile: ./src/Services/Board/Board.API/Dockerfile

  #user.api:
  #  image: ${DOCKER_REGISTRY-}userapi
  #  build:
  #    context: .
  #    dockerfile: src/Services/User/User.API/Dockerfile


  #identity.api:
  #  image: ${DOCKER_REGISTRY-}identityapi
  #  build:
  #    context: .
  #    dockerfile: src/Services/Identity/Identity.API/Dockerfile
  
  # Board Microservice #
  boardapi1: #定义"productapi1"服务 对应的产品服务项目
     image: boardapi #指定镜像名称，如果不指定 默认是：netcoremicroservicedemo_productapi1，因为下面要用到所以指定一下
     build: 
       context: .
       dockerfile: ./src/Services/Board/Board.API/Dockerfile
     ports: 
        - '5001:5001'
     environment: 
            - ASPNETCORE_URLS=http://+:5001
            - Consul:Ip=boardapi1
            - Consul:Port=5001 #程序参数
     networks: 
            - my-net
     depends_on: 
            - consul

  boardapi2:
     image: boardapi
     ports: 
        - '5002:5002'
     environment: 
            - ASPNETCORE_URLS=http://+:5002
            - Consul:Ip=boardapi2
            - Consul:Port=5002
     networks: 
            - my-net
     depends_on: 
            - boardapi1

  boardapi3:
     image: boardapi
     ports: 
        - '5003:5003'
     environment: 
            - ASPNETCORE_URLS=http://+:5003
            - Consul:Ip=boardapi3
            - Consul:Port=5003
     networks: 
            - my-net
     depends_on: 
            - boardapi1

  # User Microservice #
  userapi1:
     image: userapi
     build: 
       context: .
       dockerfile: ./src/Services/User/User.API/Dockerfile
     ports: 
        - '4000:4000'
     environment: 
            - ASPNETCORE_URLS=http://+:4000
            - Consul:Ip=userapi1
            - Consul:Port=4000
     networks: 
            - my-net
     depends_on: 
            - consul

  # Identity Microservice #
  identityapi1:
     image: identityapi
     build: 
       context: .
       dockerfile: ./src/Services/Identity/Identity.API/Dockerfile
     ports: 
        - '3000:3000'
     environment: 
            - ASPNETCORE_URLS=http://+:3000
            - Consul:Ip=identityapi1
            - Consul:Port=3000
            - UserService:Scheme=http
            - UserService:Host=userapi1
            - UserService:Port=4000
     networks: 
            - my-net
     depends_on: 
            - consul
            - userapi1

  # Gateway Service #
  gateway:
    build:
      context: .
      dockerfile: ./src/ApiGateway/Dockerfile
    ports:
         - '9070:9070' 
    environment: 
         - ASPNETCORE_URLS=http://+:9070
    networks:
         - my-net
    depends_on: 
         - boardapi1
         - boardapi2
         - boardapi3
         - userapi1
         - identityapi1

  # Consul Service #
  consul:
     image: consul #指定镜像名称为consul，本地如果没有consul镜像，会从docker远程仓库拉取
     ports: 
           - '8500:8500'
     networks: 
           - my-net
networks: #定义容器网络
  my-net: #my-net网络
    driver: bridge #网络模式为bridge